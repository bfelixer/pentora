# Plugin Manifest Generator

A tool to generate `manifest.yaml` files from a directory of YAML plugin files.

## Purpose

This tool scans a directory containing plugin YAML files, validates them, calculates checksums, and generates a manifest file that can be used by the `pentora plugin update` command to download and install plugins.

## Usage

### Basic Usage

```bash
# Generate manifest from default directory
go run cmd/tools/manifest-generator/main.go

# Specify custom directory and output
go run cmd/tools/manifest-generator/main.go \
  -dir ./path/to/plugins \
  -output manifest.yaml \
  -base-url https://plugins.pentora.ai/v1
```

### Build and Run

```bash
# Build binary
go build -o manifest-generator cmd/tools/manifest-generator/main.go

# Run
./manifest-generator -dir ./plugins -output manifest.yaml
```

## Flags

- `-dir` - Directory containing plugin YAML files (default: `./plugins`)
- `-output` - Output manifest file path (default: `manifest.yaml`)
- `-base-url` - Base URL for plugin downloads (default: `https://plugins.pentora.ai/v1`)
- `-version` - Manifest version (default: `1.0.0`)

## Example

```bash
$ go run cmd/tools/manifest-generator/main.go -dir .test/features/plugin-architecture/core-plugins
Scanning plugins in: .test/features/plugin-architecture/core-plugins
Found 1 plugin file(s)
  ✓ OpenSSH CVE-2024-6387 (regreSSHion) v1.0.0 ([ssh])

✓ Manifest generated successfully: manifest.yaml
  Total plugins: 1
  Categories: 1

Category Summary:
  ssh: 1 plugins
```

## Generated Manifest Format

```yaml
# Pentora Plugin Manifest
# Auto-generated by manifest-generator
# DO NOT EDIT MANUALLY

version: '1.0.0'
plugins:
  - name: 'OpenSSH CVE-2024-6387 (regreSSHion)'
    version: '1.0.0'
    description: 'Signal handler race condition in OpenSSH...'
    author: 'pentora-security'
    categories:
      - ssh
    url: 'https://plugins.pentora.ai/v1/ssh/ssh-cve-2024-6387.yaml'
    checksum: 'sha256:abc123...'
    size: 4567
index:
  ssh:
    - name: 'OpenSSH CVE-2024-6387 (regreSSHion)'
      version: '1.0.0'
      checksum: 'sha256:abc123...'
```

## Features

- **Automatic category detection** - Infers category from file path if not specified
- **Checksum calculation** - SHA-256 checksums for integrity verification
- **Category indexing** - Groups plugins by category for efficient filtering
- **Validation** - Ensures required fields are present
- **Recursive scanning** - Finds all `.yaml` and `.yml` files in subdirectories

## Integration with External Repository

This tool is designed to work with the external plugin repository workflow:

1. Write plugins as YAML files in a directory structure:

   ```
   plugins/
   ├── ssh/
   │   ├── ssh-cve-2024-6387.yaml
   │   └── ssh-weak-cipher.yaml
   ├── http/
   │   └── http-missing-headers.yaml
   └── tls/
       └── tls-weak-protocol.yaml
   ```

2. Run manifest generator:

   ```bash
   ./manifest-generator -dir ./plugins -output manifest.yaml
   ```

3. Commit both plugins and manifest to repository

4. Users download plugins via:
   ```bash
   pentora plugin update
   ```

## Notes

- The tool skips invalid YAML files with a warning
- Download URLs are constructed as: `{base-url}/{relative-path}`
- Relative paths preserve directory structure from the input directory
